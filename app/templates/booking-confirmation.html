{% extends 'layout.html' %}

{% block body %}
<div class="main-content">
  {% include 'partials/header.html' %}

  <div class="booking-confirmation-container">
    <h1>Booking Confirmation</h1>

    {% if booking %}
        <h2>Booking Confirmation</h2>
        <p>Event: {{ booking.event_id }}</p>
        <p>Total Price: {{ booking.total_price }}</p>

        {% if booking.status == 'to-pay' %}
            <p>Amount Paid: {{ booking.paid_amount if booking.paid_amount is not none else '0' }}</p>

            {% if completed_payments %}
                <p>Your booking is 50% paid. This event is now in process.</p>
            {% elif pending_payments %}
                <p>Your payment is in pending request. Come back again later</p>
            {% elif booking.paid_amount is none or booking.paid_amount == 0 %}
                <!-- Show the form to pay 50% if nothing is paid yet -->
                <form action="{{ url_for('main.payment', booking_id=booking.booking_id) }}" method="POST">
                    <select name="payment_method" id="payment_method_select">
                        <option value="gcash">Gcash</option>
                        <option value="maya">Maya</option>
                    </select>
                    {% set half_amount = booking.total_price / 2 %}
                    <input type="hidden" name="amount" value="{{ half_amount }}">
                    <input type="hidden" name="event_id" value="{{ booking.event_id }}">
                    <input type="hidden" name="booking_id" value="{{ booking.booking_id }}">
                    <input type="number" name="reference_no" placeholder="reference_no" required>
                    <button type="submit">Pay 50% Now</button>
                </form>

            {% else %}
                <p>Your booking is now completed</p>
            {% endif %}

        {% else %}
            <p>Your booking is not in 'to-pay' status.</p>
        {% endif %}
    {% else %}
        <p class="error-message">Booking not found.</p>
    {% endif %}



    {% if event %}
      <div class="event-summary">
        <h2>Event Details</h2>
        <p><strong>Event Name:</strong> {{ event.event_name }}</p>
        <p><strong>Number of Guests:</strong> {{ event.number_of_guests }}</p>
        <p><strong>Event Date:</strong> {{ event.event_date }}</p>
        <p><strong>Food Delivery Time:</strong> {{ event.food_time }}</p>
        <p><strong>Event Location:</strong> {{ event.event_location }}</p>
        <p><strong>Event Theme:</strong> {{ event.event_theme }}</p>
        <p><strong>Color Motif:</strong> {{ event.event_color }}</p>
      </div>
    {% else %}
      <p class="error-message">No event details found.</p>
    {% endif %}

    
            
    
    <div class="add-menu-form">
        <form action="{{ url_for('main.add_menu_choice', event_id=event.event_id) }}" method="POST" 
            style="display: {{ 'none' if pending_payments or completed_payments else 'block' }};">  
        <div class="additional-menus">
          <h3>Add More Menus</h3>
          <div>
            <label for="menus">Select Menu:</label>
            <select name="menus" id="menus">
              {% for menu in all_menus %}
                <option value="{{ menu.menu_id }}">{{ menu.menu_name }} - {{ menu.price }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="quantity">Quantity:</label>
            <input type="number" name="quantity" id="quantity" min="1" value="1">
          </div>
          <button type="submit">Add Menu</button>
        </div>
      </form>
    </div>

    {% if selected_menus %}
    <div class="menu-summary">
      <h2>Selected Menus</h2>
      <ul>
        {% for menu in selected_menus %}
          <li>
            {{ menu.menu_name }} -
            <form action="{{ url_for('main.update_menu_choice', choice_id=menu.choice_id) }}" method="POST" 
                style="display: {{ 'none' if pending_payments or completed_payments else 'inline' }};">  
              <input type="number" name="quantity" value="{{ menu.quantity }}" min="1">
              <button type="submit">Update</button>
            </form>
            <form action="{{ url_for('main.delete_menu_choice', choice_id=menu.choice_id) }}" method="POST"
                style="display: {{ 'none' if pending_payments or completed_payments else 'inline' }};">  
              <button type="submit" onclick="return confirm('Are you sure you want to remove this menu item?');">Remove</button>
            </form>
            = {{ menu.quantity * menu.price }}
          </li>
        {% endfor %}
      </ul>
      <p><strong>Total Price:</strong> {{ total_price }}</p>
    </div>
    {% else %}
      <p class="error-message">No menu items selected.</p>
    {% endif %}

    <div class="booking-status">
      {% if booking and booking.status == "to-pay" %}
        <p><strong>Status:</strong> To Pay</p>
        <p>Your booking is confirmed. Please proceed with payment to complete the process.</p>
      {% elif booking and booking.status == "processing" %}
        <p><strong>Status:</strong> Processing</p>
        <p>Your booking is being processed.</p>
      {% elif booking and booking.status == "completed" %}
        <p><strong>Status:</strong> Completed</p>
        <p>Thank you! Your booking is confirmed and paid.</p>
      {% else %}
        <p class="error-message">Booking status unknown.</p>
      {% endif %}
    </div>
  </div>

  {% include 'partials/footer.html' %}
</div>
{% endblock %}
